#!/usr/bin/env bash

set -euo pipefail

DOTFILES_DIR="$HOME/.dotfiles"

function setup_ubuntu() {
  # TODO: Implement Ubuntu setup.
  echo "Unsupported OS: Ubuntu"
  exit 1
}

function setup_macos() {
  echo "Setting up MacOS..."
  if ! [[ -x "$(command -v brew)" ]]; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi

  if ! [[ -x "$(command -v git)" ]]; then
    echo "Installing git..."
    brew install git
  fi

  if ! [[ -x "$(command -v ansible)" ]]; then
    echo "Installing ansible..."
    brew install ansible
  fi
}

os_name=$(uname -s)
echo "Detected OS: $os_name"
case "$os_name" in
Ubuntu)
  setup_ubuntu
  ;;
Darwin)
  setup_macos
  ;;
*)
  echo "Unsupported OS: $os_name"
  exit 1
  ;;
esac

if ! [[ -d "$DOTFILES_DIR" ]]; then
  echo "Cloning dotfiles repository..."
  git clone --quiet https://github.com/lexesj/dotfiles.git "$DOTFILES_DIR"
else
  echo "Updating dotfiles repository..."
  git -C "$DOTFILES_DIR" pull --quiet
fi

ansible-playbook "$DOTFILES_DIR/main.yml" "$@"
